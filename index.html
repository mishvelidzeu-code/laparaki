<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ®áƒ›áƒ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒáƒ“</title>

<meta name="theme-color" content="#2563eb">
<link rel="apple-touch-icon" href="icon-192.png">

<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f5f7ff;
  color:#0f172a;
}
.container{max-width:1200px;margin:auto;padding:20px}
.header{
  background:#2563eb;
  color:#fff;
  padding:24px;
  border-radius:18px;
  text-align:center;
}
.main{
  margin-top:20px;
  background:#fff;
  padding:20px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}
textarea{
  width:100%;
  height:40vh;
  min-height:220px;
  padding:16px;
  font-size:18px;
  line-height:1.6;
  border-radius:14px;
  border:1px solid #cbd5e1;
  outline:none;
}
textarea:focus{border-color:#2563eb}

.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:14px;
  justify-content:center;
}
.controls button{
  padding:12px 22px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:600;
  font-size:15px;
  transition: opacity 0.2s;
}
.controls button:active { opacity: 0.7; }

.start{background:#2563eb;color:#fff}
.stop{background:#dc2626;color:#fff}
.copy{background:#16a34a;color:#fff}
.clear{background:#64748b;color:#fff}
.word{background:#0f4c81;color:#fff}

.settings{
  margin-top:14px;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:10px;
  color:#475569;
  justify-content:center;
}
.indicator{
  margin-top:10px;
  font-size:14px;
  color:#2563eb;
  display:none;
  font-weight:bold;
  text-align:center;
}
select{
  padding:6px;
  border-radius:6px;
  border:1px solid #cbd5e1;
}
@media (max-width: 768px){
  textarea{ height:32vh; min-height:180px; }
  .header{ padding:16px 14px; }
  .header h1{ font-size:22px; }
}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ®áƒ›áƒ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒáƒ“</h1>
    <p>áƒáƒ•áƒ¢áƒáƒ›áƒáƒ¢áƒ£áƒ áƒ˜ áƒáƒ£áƒœáƒ¥áƒ¢áƒ£áƒáƒªáƒ˜áƒ â€¢ áƒáƒ‘áƒ–áƒáƒªáƒ”áƒ‘áƒ˜ â€¢ áƒ£áƒ¡áƒáƒ¤áƒ áƒ—áƒ®áƒ</p>
  </div>

  <div class="main">
    <textarea id="text" spellcheck="false" placeholder="áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒšáƒáƒáƒáƒ áƒáƒ™áƒ˜â€¦"></textarea>

    <div class="indicator" id="paragraphIndicator">âš¡ áƒáƒ®áƒáƒšáƒ˜ áƒáƒ‘áƒ–áƒáƒªáƒ˜</div>

    <div class="settings">
      <span>áƒáƒáƒ£áƒ–áƒ áƒáƒ‘áƒ–áƒáƒªáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡:</span>
      <select id="pauseSelect">
        <option value="2000">2 áƒ¬áƒáƒ›áƒ˜</option>
        <option value="3000" selected>3 áƒ¬áƒáƒ›áƒ˜</option>
        <option value="5000">5 áƒ¬áƒáƒ›áƒ˜</option>
      </select>
    </div>

    <div class="controls">
      <button class="start" onclick="startRec()">ğŸ™ï¸ áƒ“áƒáƒ¬áƒ§áƒ”áƒ‘áƒ</button>
      <button class="stop" onclick="stopRec()">ğŸ›‘ áƒ¨áƒ”áƒ©áƒ”áƒ áƒ”áƒ‘áƒ</button>
      <button class="copy" onclick="copyText()">ğŸ“‹ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ</button>
      <button class="clear" onclick="clearText()">ğŸ—‘ï¸ áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</button>
      <button class="word" onclick="downloadWord()">ğŸ“„ Word</button>
    </div>
    <p style="font-size:12px;color:#64748b;text-align:center;margin-top:15px">
      ğŸ’¡ iPhone-áƒ–áƒ” áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ”áƒ— Safari. áƒ™áƒáƒ›áƒáƒ˜áƒ£áƒ¢áƒ”áƒ áƒ–áƒ” - Chrome.
    </p>
  </div>
</div>

<script>
let recognition;
let finalText = "";
let manuallyStopped = true;
let lastResultTime = Date.now();

const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;

function cleanText(t){
  return t.replace(/[\u0000-\u001F\u007F-\u009F\u200B-\u200D\uFEFF]/g,"");
}

function smartPunctuation(text){
  text = text.trim();
  if(!text) return "";
  text = text.replace(/\s+(áƒ›áƒáƒ’áƒ áƒáƒ›|áƒ—áƒ£áƒ›áƒªáƒ|áƒ áƒáƒ“áƒ’áƒáƒœ|áƒ®áƒáƒšáƒ|áƒ áƒáƒ›)\s+/gi, ", $1 ");
  const questionWords = /\b(áƒ áƒáƒ¢áƒáƒ›|áƒ áƒáƒ’áƒáƒ |áƒ áƒáƒ“áƒ˜áƒ¡|áƒ¡áƒáƒ“|áƒ•áƒ˜áƒœ|áƒ•áƒ˜áƒ¡|áƒ áƒáƒ¡|áƒ áƒáƒ›áƒ”áƒšáƒ˜|áƒ áƒáƒ›áƒ“áƒ”áƒœáƒ˜|áƒœáƒ£áƒ—áƒ£|áƒ®áƒáƒ›)\b/i;
  if(questionWords.test(text)) return text + "? ";
  return text + ". ";
}

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.lang = "ka-GE";
  recognition.continuous = false; // iOS-áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ false áƒ£áƒ¤áƒ áƒ áƒ¡áƒ¢áƒáƒ‘áƒ˜áƒšáƒ£áƒ áƒ˜áƒ
  recognition.interimResults = true;

  recognition.onresult = e => {
    const now = Date.now();
    const PAUSE = Number(pauseSelect.value);
    let interim = "";

    for(let i=e.resultIndex; i<e.results.length; i++){
      let t = cleanText(e.results[i][0].transcript);
      if(e.results[i].isFinal){
        let gap = now - lastResultTime;
        if(gap >= PAUSE && finalText.trim().length > 0){
          finalText = finalText.trim() + "\n\n";
          showIndicator();
        }
        finalText += smartPunctuation(t);
        lastResultTime = now;
      } else {
        interim += t;
      }
    }
    const textArea = document.getElementById('text');
    textArea.value = (finalText + interim).replace(/\s+/g, " ");
    textArea.scrollTop = textArea.scrollHeight;
  };

  recognition.onend = () => {
    if (!manuallyStopped) {
      try { recognition.start(); } catch(err) {}
    }
  };
  
  recognition.onerror = e => {
    console.log("Error:", e.error);
    if(e.error === 'not-allowed') alert("áƒ©áƒáƒ áƒ—áƒ”áƒ— áƒ›áƒ˜áƒ™áƒ áƒáƒ¤áƒáƒœáƒ˜áƒ¡ áƒœáƒ”áƒ‘áƒáƒ áƒ—áƒ•áƒ Safari-áƒ¡ áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜áƒ“áƒáƒœ.");
  };
}

function startRec(){
  if(!SpeechRecognition) return alert("áƒ—áƒ¥áƒ•áƒ”áƒœáƒ¡ áƒ‘áƒ áƒáƒ£áƒ–áƒ”áƒ áƒ¡ áƒáƒ  áƒáƒ¥áƒ•áƒ¡ áƒ®áƒ›áƒ˜áƒ¡ áƒ›áƒ®áƒáƒ áƒ“áƒáƒ­áƒ”áƒ áƒ.");
  
  // Audio Context-áƒ˜áƒ¡ áƒ’áƒáƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ”áƒ‘áƒ iOS-áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();

  manuallyStopped = false;
  finalText = document.getElementById('text').value.trim() ? document.getElementById('text').value.trim() + " " : "";
  
  try {
    recognition.start();
  } catch(e) {
    recognition.stop();
    setTimeout(() => recognition.start(), 200);
  }
}

function stopRec(){
  manuallyStopped = true;
  recognition.stop();
}

function showIndicator(){
  const ind = document.getElementById('paragraphIndicator');
  ind.style.display="block";
  setTimeout(()=>ind.style.display="none",1200);
}

function copyText(){
  const val = document.getElementById('text').value;
  navigator.clipboard.writeText(val.trim()).then(() => alert("áƒ“áƒáƒ™áƒáƒáƒ˜áƒ áƒ“áƒ!"));
}

function clearText(){
  if(confirm("áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜áƒ¡ áƒ¡áƒ áƒ£áƒšáƒáƒ“ áƒ¬áƒáƒ¨áƒšáƒ?")){
    finalText="";
    document.getElementById('text').value="";
  }
}

function downloadWord(){
  const { Document, Packer, Paragraph, TextRun, AlignmentType } = window.docx;
  const lines = document.getElementById('text').value.split(/\n\n/);
  const doc = new Document({
    sections:[{
      children: lines.filter(l=>l.trim()).map(l =>
        new Paragraph({
          alignment: AlignmentType.JUSTIFIED,
          spacing:{ after:200 },
          children:[ new TextRun({ text:l.trim(), font: "Sylfaen", size: 24, language:{ id:"ka-GE" } }) ]
        })
      )
    }]
  });
  Packer.toBlob(doc).then(b => saveAs(b,"qartuli_teqsti.docx"));
}
</script>
</body>
</html>