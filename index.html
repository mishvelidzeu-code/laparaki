<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ®áƒ›áƒ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒáƒ“</title>

<meta name="theme-color" content="#2563eb">
<link rel="apple-touch-icon" href="icon-192.png">

<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,sans-serif;
  background:#f5f7ff;
  color:#0f172a;
}
.container{max-width:1200px;margin:auto;padding:20px}
.header{
  background:#2563eb;
  color:#fff;
  padding:24px;
  border-radius:18px;
  text-align:center;
}
.main{
  margin-top:20px;
  background:#fff;
  padding:20px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}
textarea{
  width:100%;
  height:40vh;
  min-height:220px;
  padding:16px;
  font-size:18px;
  line-height:1.6;
  border-radius:14px;
  border:1px solid #cbd5e1;
  outline:none;
}
.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:14px;
  justify-content:center;
}
.controls button{
  padding:12px 22px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:600;
  font-size:15px;
  transition: opacity 0.2s;
}
.start{background:#2563eb;color:#fff}
.stop{background:#dc2626;color:#fff}
.copy{background:#16a34a;color:#fff}
.clear{background:#64748b;color:#fff}
.word{background:#0f4c81;color:#fff}

.settings{
  margin-top:14px;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:10px;
  color:#475569;
  justify-content:center;
}
.indicator{
  margin-top:10px;
  font-size:14px;
  color:#2563eb;
  display:none;
  font-weight:bold;
  text-align:center;
}
@media (max-width: 768px){
  textarea{ height:32vh; min-height:180px; }
  .header h1{ font-size:22px; }
}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ®áƒ›áƒ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒáƒ“</h1>
    <p id="status">áƒáƒ•áƒ¢áƒáƒ›áƒáƒ¢áƒ£áƒ áƒ˜ áƒáƒ£áƒœáƒ¥áƒ¢áƒ£áƒáƒªáƒ˜áƒ â€¢ áƒáƒ‘áƒ–áƒáƒªáƒ”áƒ‘áƒ˜ â€¢ Word</p>
  </div>

  <div class="main">
    <textarea id="text" spellcheck="false" placeholder="áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒšáƒáƒáƒáƒ áƒáƒ™áƒ˜â€¦"></textarea>
    <div class="indicator" id="paragraphIndicator">âš¡ áƒáƒ®áƒáƒšáƒ˜ áƒáƒ‘áƒ–áƒáƒªáƒ˜</div>

    <div class="settings">
      <span>áƒáƒáƒ£áƒ–áƒ áƒáƒ‘áƒ–áƒáƒªáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡:</span>
      <select id="pauseSelect" style="padding:5px; border-radius:5px;">
        <option value="2000">2 áƒ¬áƒáƒ›áƒ˜</option>
        <option value="3000" selected>3 áƒ¬áƒáƒ›áƒ˜</option>
        <option value="5000">5 áƒ¬áƒáƒ›áƒ˜</option>
      </select>
    </div>

    <div class="controls">
      <button class="start" onclick="initAndStart()">ğŸ™ï¸ áƒ“áƒáƒ¬áƒ§áƒ”áƒ‘áƒ</button>
      <button class="stop" onclick="stopRec()">ğŸ›‘ áƒ¨áƒ”áƒ©áƒ”áƒ áƒ”áƒ‘áƒ</button>
      <button class="copy" onclick="copyText()">ğŸ“‹ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ</button>
      <button class="clear" onclick="clearText()">ğŸ—‘ï¸ áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</button>
      <button class="word" onclick="downloadWord()">ğŸ“„ Word</button>
    </div>
  </div>
</div>

<script>
let recognition;
let finalText = "";
let isListening = false;
let lastResultTime = Date.now();

async function initAndStart() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
        alert("áƒ›áƒ˜áƒ™áƒ áƒáƒ¤áƒáƒœáƒ–áƒ” áƒ¬áƒ•áƒ“áƒáƒ›áƒ áƒ£áƒáƒ áƒ§áƒáƒ¤áƒ˜áƒšáƒ˜áƒ.");
        return;
    }

    const SpeechRec = window.webkitSpeechRecognition || window.SpeechRecognition;
    if (!SpeechRec) {
        alert("áƒáƒ› áƒ‘áƒ áƒáƒ£áƒ–áƒ”áƒ áƒ¡ áƒáƒ  áƒáƒ¥áƒ•áƒ¡ áƒ›áƒ®áƒáƒ áƒ“áƒáƒ­áƒ”áƒ áƒ.");
        return;
    }

    if (!isListening) {
        recognition = new SpeechRec();
        recognition.lang = 'ka-GE';
        recognition.continuous = false; 
        recognition.interimResults = true;

        recognition.onstart = () => {
            isListening = true;
            document.getElementById('status').innerText = "ğŸ”´ áƒ’áƒ˜áƒ¡áƒ›áƒ”áƒœáƒ—... áƒ˜áƒ¡áƒáƒ£áƒ‘áƒ áƒ”áƒ—";
            finalText = document.getElementById('text').value.trim() ? document.getElementById('text').value.trim() + " " : "";
        };

        recognition.onresult = (e) => {
            const now = Date.now();
            const PAUSE = Number(document.getElementById('pauseSelect').value);
            let interim = "";

            for (let i = e.resultIndex; i < e.results.length; i++) {
                let transcript = e.results[i][0].transcript;
                if (e.results[i].isFinal) {
                    let gap = now - lastResultTime;
                    
                    if (gap >= PAUSE && finalText.trim().length > 0) {
                        if (!finalText.trim().endsWith(".") && !finalText.trim().endsWith("?")) {
                            finalText = finalText.trim() + ". \n\n";
                        } else {
                            finalText = finalText.trim() + "\n\n";
                        }
                        showIndicator();
                    }
                    
                    finalText += smartPunctuation(transcript);
                    lastResultTime = now;
                } else {
                    interim += transcript;
                }
            }
            const displayArea = document.getElementById('text');
            displayArea.value = (finalText + interim).replace(/\s\s+/g, ' ');
            displayArea.scrollTop = displayArea.scrollHeight;
        };

        recognition.onend = () => {
            if (isListening) {
                setTimeout(() => { try { recognition.start(); } catch(err) {} }, 100);
            } else {
                document.getElementById('status').innerText = "áƒáƒ•áƒ¢áƒáƒ›áƒáƒ¢áƒ£áƒ áƒ˜ áƒáƒ£áƒœáƒ¥áƒ¢áƒ£áƒáƒªáƒ˜áƒ â€¢ áƒáƒ‘áƒ–áƒáƒªáƒ”áƒ‘áƒ˜ â€¢ Word";
            }
        };

        recognition.start();
    }
}

function stopRec() {
    isListening = false;
    if (recognition) recognition.stop();
}

function smartPunctuation(t) {
    t = t.trim();
    if (!t) return "";

    const conjunctions = ["áƒ áƒáƒ›", "áƒ›áƒáƒ’áƒ áƒáƒ›", "áƒ®áƒáƒšáƒ", "áƒ—áƒ£áƒ›áƒªáƒ", "áƒ áƒáƒ“áƒ’áƒáƒœ", "áƒáƒ›áƒ˜áƒ¢áƒáƒ›", "áƒ—áƒáƒ áƒ”áƒ›", "áƒ¡áƒáƒœáƒáƒ›", "áƒ•áƒ˜áƒ“áƒ áƒ”", "áƒ•áƒ˜áƒœáƒáƒ˜áƒ“áƒáƒœ", "áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª"];
    conjunctions.forEach(word => {
        const regex = new RegExp(`\\s+(${word})\\b`, "gi");
        t = t.replace(regex, ", $1");
    });

    const questionWords = /\b(áƒ áƒáƒ¢áƒáƒ›|áƒ áƒáƒ’áƒáƒ |áƒ áƒáƒ“áƒ˜áƒ¡|áƒ¡áƒáƒ“|áƒ•áƒ˜áƒœ|áƒ•áƒ˜áƒ¡|áƒ áƒáƒ¡|áƒ áƒáƒ›áƒ”áƒšáƒ˜|áƒ áƒáƒ›áƒ“áƒ”áƒœáƒ˜|áƒ®áƒáƒ›|áƒœáƒ£áƒ—áƒ£|áƒ’áƒáƒœáƒ|áƒ¡áƒáƒ˜áƒ—|áƒ¡áƒáƒ˜áƒ“áƒáƒœ)\b/i;
    const isQuestion = questionWords.test(t);

    const addressWords = /\b(áƒ›áƒ”áƒ’áƒáƒ‘áƒ áƒ”áƒ‘áƒ|áƒ®áƒáƒšáƒ®áƒ|áƒ‘áƒáƒ¢áƒáƒœáƒ|áƒ¥áƒáƒšáƒ‘áƒáƒ¢áƒáƒœáƒ|áƒ‘áƒáƒ•áƒ¨áƒ•áƒ”áƒ‘áƒ)\b/i;
    t = t.replace(addressWords, "$1,");

    t = t.replace(/,\s*,/g, ",");
    return t + (isQuestion ? "? " : " ");
}

function showIndicator() {
    const ind = document.getElementById('paragraphIndicator');
    ind.style.display = "block";
    setTimeout(() => ind.style.display = "none", 1200);
}

function copyText() {
    const txt = document.getElementById('text');
    navigator.clipboard.writeText(txt.value.trim()).then(() => alert("áƒ“áƒáƒ™áƒáƒáƒ˜áƒ áƒ“áƒ!"));
}

function clearText() {
    if (confirm("áƒ¬áƒáƒ•áƒ¨áƒáƒšáƒáƒ— áƒ§áƒ•áƒ”áƒšáƒáƒ¤áƒ”áƒ áƒ˜?")) {
        finalText = "";
        document.getElementById('text').value = "";
    }
}

function downloadWord() {
    const { Document, Packer, Paragraph, TextRun, AlignmentType } = window.docx;
    const lines = document.getElementById('text').value.split(/\n\n/);
    const doc = new Document({
        sections: [{
            children: lines.filter(l => l.trim()).map(l =>
                new Paragraph({
                    alignment: AlignmentType.JUSTIFIED,
                    spacing: { after: 200 },
                    children: [new TextRun({ text: l.trim(), font: "Sylfaen", size: 24 })]
                })
            )
        }]
    });
    Packer.toBlob(doc).then(blob => saveAs(blob, "teqsti.docx"));
}
</script>
</body>
</html>